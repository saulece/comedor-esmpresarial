<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comedor Empresarial - Demo Offline</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #3498db;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h2 {
            margin-top: 0;
            color: #3498db;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        
        .btn {
            display: inline-block;
            background-color: #3498db;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            text-decoration: none;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success { background-color: #2ecc71; }
        .btn-success:hover { background-color: #27ae60; }
        
        .btn-warning { background-color: #f39c12; }
        .btn-warning:hover { background-color: #e67e22; }
        
        .btn-danger { background-color: #e74c3c; }
        .btn-danger:hover { background-color: #c0392b; }
        
        .btn-secondary { background-color: #95a5a6; }
        .btn-secondary:hover { background-color: #7f8c8d; }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .status-indicator {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        
        .status-success { border-left-color: #2ecc71; background-color: #e8f8f5; }
        .status-error { border-left-color: #e74c3c; background-color: #fdedec; }
        .status-warning { border-left-color: #f39c12; background-color: #fef9e7; }
        .status-info { border-left-color: #3498db; background-color: #eaf2f8; }
        
        .connection-status {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-dot.online { background-color: #2ecc71; }
        .status-dot.offline { background-color: #e74c3c; }
        
        .pending-operations {
            margin-top: 15px;
        }
        
        .pending-operations-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .operation-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .operation-item:last-child {
            border-bottom: none;
        }
        
        .operation-type {
            font-weight: bold;
            margin-right: 10px;
        }
        
        .operation-type.create { color: #2ecc71; }
        .operation-type.update { color: #3498db; }
        .operation-type.delete { color: #e74c3c; }
        
        .operation-details {
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .data-table th, .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .data-table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .btn {
                display: block;
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Comedor Empresarial - Demo Offline</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <h2><i class="fas fa-info-circle"></i> Estado de Conexión</h2>
            
            <div class="connection-status">
                <div id="statusDot" class="status-dot online"></div>
                <div id="statusText">Conectado</div>
            </div>
            
            <div id="connectionDetails" class="status-indicator status-info">
                Verificando estado de conexión...
            </div>
            
            <button id="toggleOffline" class="btn btn-warning">
                <i class="fas fa-wifi-slash"></i> Simular Desconexión
            </button>
            
            <button id="syncNow" class="btn btn-success">
                <i class="fas fa-sync"></i> Sincronizar Ahora
            </button>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-database"></i> Operaciones Offline</h2>
            
            <div class="form-group">
                <label for="operationType">Tipo de Operación:</label>
                <select id="operationType">
                    <option value="create">Crear</option>
                    <option value="update">Actualizar</option>
                    <option value="delete">Eliminar</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="operationCollection">Colección:</label>
                <select id="operationCollection">
                    <option value="menus">Menús</option>
                    <option value="coordinators">Coordinadores</option>
                    <option value="attendanceConfirmations">Confirmaciones de Asistencia</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="operationId">ID del Documento:</label>
                <input type="text" id="operationId" placeholder="ID del documento">
            </div>
            
            <div id="dataFields" class="form-group">
                <label for="operationData">Datos (JSON):</label>
                <textarea id="operationData" rows="5" placeholder='{"campo1": "valor1", "campo2": "valor2"}'></textarea>
            </div>
            
            <button id="executeOperation" class="btn btn-success">
                <i class="fas fa-play"></i> Ejecutar Operación
            </button>
            
            <div id="operationStatus" class="status-indicator" style="display: none;">
                Esperando acción...
            </div>
            
            <div class="pending-operations">
                <h3>Operaciones Pendientes (<span id="pendingCount">0</span>)</h3>
                
                <div id="pendingOperationsList" class="pending-operations-list">
                    <p>No hay operaciones pendientes.</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-table"></i> Datos Locales</h2>
            
            <div class="form-group">
                <label for="dataCollection">Colección:</label>
                <select id="dataCollection">
                    <option value="menus">Menús</option>
                    <option value="coordinators">Coordinadores</option>
                    <option value="attendanceConfirmations">Confirmaciones de Asistencia</option>
                </select>
            </div>
            
            <button id="loadLocalData" class="btn">
                <i class="fas fa-database"></i> Cargar Datos Locales
            </button>
            
            <div id="localDataContainer">
                <table id="localDataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Datos</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2">Seleccione una colección y haga clic en "Cargar Datos Locales"</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-cog"></i> Configuración Offline</h2>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="enablePersistence" checked disabled>
                    Habilitar persistencia de datos (IndexedDB)
                </label>
                <p class="help-text">Esta opción está habilitada por defecto y no se puede deshabilitar.</p>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="autoSync" checked>
                    Sincronizar automáticamente al recuperar conexión
                </label>
            </div>
            
            <button id="clearPendingOperations" class="btn btn-danger">
                <i class="fas fa-trash"></i> Limpiar Operaciones Pendientes
            </button>
            
            <div id="configStatus" class="status-indicator" style="display: none;">
                Esperando acción...
            </div>
        </div>
        
        <div class="card">
            <h2><i class="fas fa-link"></i> Enlaces Útiles</h2>
            <a href="index.html" class="btn btn-secondary">
                <i class="fas fa-home"></i> Página Principal
            </a>
            <a href="coordinator.html" class="btn btn-secondary">
                <i class="fas fa-user-tie"></i> Panel de Coordinador
            </a>
            <a href="export-demo.html" class="btn btn-secondary">
                <i class="fas fa-file-export"></i> Exportación de Datos
            </a>
            <a href="notifications-demo.html" class="btn btn-secondary">
                <i class="fas fa-bell"></i> Notificaciones
            </a>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";
        import { firebaseConfig } from "./js/firebase-config.js";
        import FirebaseOffline from "./js/firebase-offline.js";
        import { FirestoreUtil } from "./js/firebase-storage.js";
        
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Elementos DOM
        const statusDotEl = document.getElementById('statusDot');
        const statusTextEl = document.getElementById('statusText');
        const connectionDetailsEl = document.getElementById('connectionDetails');
        const toggleOfflineBtn = document.getElementById('toggleOffline');
        const syncNowBtn = document.getElementById('syncNow');
        const pendingCountEl = document.getElementById('pendingCount');
        const pendingOperationsListEl = document.getElementById('pendingOperationsList');
        const operationStatusEl = document.getElementById('operationStatus');
        const configStatusEl = document.getElementById('configStatus');
        const localDataTableEl = document.getElementById('localDataTable');
        
        // Variables de estado
        let isOfflineMode = false;
        
        // Inicializar sistema offline
        FirebaseOffline.initialize().then(() => {
            // Actualizar interfaz con el estado inicial
            updateConnectionStatus();
            
            // Registrar callback para cambios de estado
            FirebaseOffline.onStatusChange(updateConnectionStatus);
            
            // Registrar callback para sincronización completada
            FirebaseOffline.onSyncComplete(syncCompleteHandler);
        });
        
        // Actualizar estado de conexión en la interfaz
        function updateConnectionStatus(status) {
            if (!status) {
                // Si no hay status, obtenerlo del sistema
                status = {
                    isOnline: navigator.onLine,
                    offlineMode: isOfflineMode,
                    persistenceEnabled: true,
                    pendingOperations: FirebaseOffline.getPendingOperationsCount()
                };
            }
            
            // Actualizar indicador visual
            if (status.isOnline && !status.offlineMode) {
                statusDotEl.className = 'status-dot online';
                statusTextEl.textContent = 'Conectado';
                toggleOfflineBtn.innerHTML = '<i class="fas fa-wifi-slash"></i> Simular Desconexión';
                isOfflineMode = false;
            } else {
                statusDotEl.className = 'status-dot offline';
                statusTextEl.textContent = 'Desconectado';
                toggleOfflineBtn.innerHTML = '<i class="fas fa-wifi"></i> Simular Reconexión';
                isOfflineMode = true;
            }
            
            // Actualizar detalles de conexión
            connectionDetailsEl.innerHTML = `
                <strong>Estado de Red:</strong> ${status.isOnline ? 'Conectado' : 'Desconectado'}<br>
                <strong>Modo Offline Manual:</strong> ${status.offlineMode ? 'Activado' : 'Desactivado'}<br>
                <strong>Persistencia Local:</strong> ${status.persistenceEnabled ? 'Habilitada' : 'Deshabilitada'}<br>
                <strong>Operaciones Pendientes:</strong> ${status.pendingOperations}
            `;
            
            // Actualizar contador de operaciones pendientes
            pendingCountEl.textContent = status.pendingOperations;
            
            // Actualizar lista de operaciones pendientes
            updatePendingOperationsList();
            
            // Actualizar clase del indicador de estado
            if (status.isOnline && !status.offlineMode) {
                connectionDetailsEl.className = 'status-indicator status-success';
            } else if (!status.isOnline) {
                connectionDetailsEl.className = 'status-indicator status-error';
            } else {
                connectionDetailsEl.className = 'status-indicator status-warning';
            }
        }
        
        // Actualizar lista de operaciones pendientes
        function updatePendingOperationsList() {
            const operations = FirebaseOffline.getPendingOperations();
            
            if (operations.length === 0) {
                pendingOperationsListEl.innerHTML = '<p>No hay operaciones pendientes.</p>';
                return;
            }
            
            pendingOperationsListEl.innerHTML = '';
            
            operations.forEach(operation => {
                const operationEl = document.createElement('div');
                operationEl.className = 'operation-item';
                
                // Formatear timestamp
                const date = new Date(operation.timestamp);
                const formattedDate = date.toLocaleString();
                
                operationEl.innerHTML = `
                    <span class="operation-type ${operation.type}">
                        ${operation.type.toUpperCase()}
                    </span>
                    <strong>${operation.collection}/${operation.docId}</strong>
                    <div class="operation-details">
                        <div>Creada: ${formattedDate}</div>
                        <div>Intentos: ${operation.attempts}</div>
                        ${operation.data ? `<div>Datos: ${JSON.stringify(operation.data).substring(0, 100)}${JSON.stringify(operation.data).length > 100 ? '...' : ''}</div>` : ''}
                    </div>
                `;
                
                pendingOperationsListEl.appendChild(operationEl);
            });
        }
        
        // Manejador para sincronización completada
        function syncCompleteHandler(result) {
            operationStatusEl.textContent = `Sincronización completada. ${result.successful} de ${result.total} operaciones sincronizadas. ${result.pending} pendientes.`;
            operationStatusEl.className = 'status-indicator status-success';
            operationStatusEl.style.display = 'block';
            
            // Actualizar contador y lista
            updateConnectionStatus();
            
            // Ocultar mensaje después de 5 segundos
            setTimeout(() => {
                operationStatusEl.style.display = 'none';
            }, 5000);
        }
        
        // Alternar modo offline
        toggleOfflineBtn.addEventListener('click', async () => {
            try {
                if (isOfflineMode) {
                    await FirebaseOffline.goOnline();
                } else {
                    await FirebaseOffline.goOffline();
                }
                
                // La interfaz se actualizará a través del callback onStatusChange
            } catch (error) {
                console.error('Error al cambiar modo offline:', error);
                
                operationStatusEl.textContent = `Error: ${error.message}`;
                operationStatusEl.className = 'status-indicator status-error';
                operationStatusEl.style.display = 'block';
            }
        });
        
        // Sincronizar ahora
        syncNowBtn.addEventListener('click', async () => {
            try {
                operationStatusEl.textContent = 'Sincronizando operaciones pendientes...';
                operationStatusEl.className = 'status-indicator status-info';
                operationStatusEl.style.display = 'block';
                
                await FirebaseOffline.syncPendingOperations();
                
                // El resultado se manejará en el callback onSyncComplete
            } catch (error) {
                console.error('Error al sincronizar:', error);
                
                operationStatusEl.textContent = `Error: ${error.message}`;
                operationStatusEl.className = 'status-indicator status-error';
            }
        });
        
        // Mostrar/ocultar campos de datos según tipo de operación
        document.getElementById('operationType').addEventListener('change', (e) => {
            const type = e.target.value;
            document.getElementById('dataFields').style.display = 
                type === 'delete' ? 'none' : 'block';
        });
        
        // Ejecutar operación
        document.getElementById('executeOperation').addEventListener('click', async () => {
            try {
                const type = document.getElementById('operationType').value;
                const collection = document.getElementById('operationCollection').value;
                const id = document.getElementById('operationId').value;
                const dataStr = document.getElementById('operationData').value;
                
                if (!id) {
                    throw new Error('Debe especificar un ID de documento');
                }
                
                // Validar datos para create y update
                let data = null;
                if (type !== 'delete') {
                    if (!dataStr) {
                        throw new Error('Debe especificar datos para crear o actualizar');
                    }
                    
                    try {
                        data = JSON.parse(dataStr);
                    } catch (e) {
                        throw new Error('Los datos deben ser un objeto JSON válido');
                    }
                }
                
                operationStatusEl.textContent = 'Registrando operación...';
                operationStatusEl.className = 'status-indicator status-info';
                operationStatusEl.style.display = 'block';
                
                // Registrar operación
                const operationId = FirebaseOffline.registerPendingOperation({
                    type,
                    collection,
                    id,
                    data
                });
                
                operationStatusEl.textContent = `Operación registrada con ID: ${operationId}`;
                operationStatusEl.className = 'status-indicator status-success';
                
                // Limpiar formulario
                if (type !== 'delete') {
                    document.getElementById('operationData').value = '';
                }
                
                // Actualizar lista de operaciones pendientes
                updateConnectionStatus();
            } catch (error) {
                console.error('Error al ejecutar operación:', error);
                
                operationStatusEl.textContent = `Error: ${error.message}`;
                operationStatusEl.className = 'status-indicator status-error';
                operationStatusEl.style.display = 'block';
            }
        });
        
        // Cargar datos locales
        document.getElementById('loadLocalData').addEventListener('click', async () => {
            try {
                const collection = document.getElementById('dataCollection').value;
                
                // Obtener datos
                const data = await FirestoreUtil.getAll(collection);
                
                // Limpiar tabla
                const tbody = localDataTableEl.querySelector('tbody');
                tbody.innerHTML = '';
                
                if (data.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="2">No hay datos en la colección ${collection}</td>`;
                    tbody.appendChild(row);
                    return;
                }
                
                // Llenar tabla
                data.forEach(item => {
                    const row = document.createElement('tr');
                    
                    // Formatear datos para mostrar
                    const formattedData = { ...item };
                    delete formattedData.id; // Ya mostramos el ID en la primera columna
                    
                    // Convertir a JSON para mostrar
                    const dataString = JSON.stringify(formattedData, null, 2)
                        .replace(/[{}"]/g, '')
                        .replace(/,/g, '<br>')
                        .replace(/:/g, ': ');
                    
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td><pre style="margin: 0; white-space: pre-wrap;">${dataString}</pre></td>
                    `;
                    
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error al cargar datos locales:', error);
                
                const tbody = localDataTableEl.querySelector('tbody');
                tbody.innerHTML = `<tr><td colspan="2">Error al cargar datos: ${error.message}</td></tr>`;
            }
        });
        
        // Guardar configuración
        document.getElementById('autoSync').addEventListener('change', (e) => {
            const autoSync = e.target.checked;
            
            // Guardar en localStorage para persistencia
            localStorage.setItem('offlineSettings', JSON.stringify({
                autoSync
            }));
            
            configStatusEl.textContent = 'Configuración guardada.';
            configStatusEl.className = 'status-indicator status-success';
            configStatusEl.style.display = 'block';
            
            // Ocultar mensaje después de 3 segundos
            setTimeout(() => {
                configStatusEl.style.display = 'none';
            }, 3000);
        });
        
        // Limpiar operaciones pendientes
        document.getElementById('clearPendingOperations').addEventListener('click', () => {
            try {
                // Limpiar operaciones pendientes
                localStorage.removeItem('pendingOperations');
                
                // Recargar página para reiniciar estado
                window.location.reload();
            } catch (error) {
                console.error('Error al limpiar operaciones pendientes:', error);
                
                configStatusEl.textContent = `Error: ${error.message}`;
                configStatusEl.className = 'status-indicator status-error';
                configStatusEl.style.display = 'block';
            }
        });
        
        // Cargar configuración guardada
        const savedSettings = JSON.parse(localStorage.getItem('offlineSettings') || '{}');
        if (savedSettings.autoSync !== undefined) {
            document.getElementById('autoSync').checked = savedSettings.autoSync;
        }
    </script>
</body>
</html>
