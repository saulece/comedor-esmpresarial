<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo de Sincronización en Tiempo Real - Comedor Empresarial</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .realtime-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        .status-online {
            background-color: #E6F4EA;
            color: #137333;
        }
        
        .status-offline {
            background-color: #FCE8E6;
            color: #C5221F;
        }
        
        .realtime-panel {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .panel-section {
            flex: 1;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h3 {
            margin: 0;
        }
        
        .refresh-btn {
            background: none;
            border: none;
            color: #4285F4;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .item-name {
            font-weight: bold;
        }
        
        .item-meta {
            color: #666;
            font-size: 0.9rem;
        }
        
        .item-actions {
            display: flex;
            gap: 8px;
        }
        
        .item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        
        .edit-btn {
            color: #4285F4;
        }
        
        .delete-btn {
            color: #EA4335;
        }
        
        .add-form {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn-primary {
            background-color: #4285F4;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .update-log {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #f5f5f5;
            border-radius: 4px;
            padding: 10px;
        }
        
        .log-entry {
            font-family: monospace;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .log-timestamp {
            color: #666;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            .realtime-panel {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Comedor Empresarial</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="admin.html">Administración</a></li>
                    <li><a href="coordinator.html">Coordinador</a></li>
                    <li><a href="realtime-demo.html" class="active">Demo Tiempo Real</a></li>
                    <li><a href="firebase-config.html">Configuración</a></li>
                </ul>
                <div id="user-container" class="user-info">
                    <span id="user-email"></span>
                    <a id="login-btn" href="login.html" class="btn btn-small">Iniciar Sesión</a>
                    <button id="logout-btn" class="btn btn-small" style="display: none;">Cerrar Sesión</button>
                    <div id="firebase-status" class="status-badge status-offline">
                        <i class="fas fa-cloud"></i> Offline
                    </div>
                </div>
            </nav>
        </div>
    </header>
    
    <main class="realtime-container">
        <h2>Demostración de Sincronización en Tiempo Real</h2>
        <p>Esta página muestra cómo funciona la sincronización en tiempo real con Firebase. Cualquier cambio realizado en los datos se reflejará automáticamente en todos los dispositivos conectados sin necesidad de recargar la página.</p>
        
        <div class="realtime-panel">
            <div class="panel-section">
                <div class="section-header">
                    <h3><i class="fas fa-utensils"></i> Menús</h3>
                    <button class="refresh-btn" id="refresh-menus">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <ul id="menu-list" class="item-list">
                    <!-- Se llenará dinámicamente -->
                </ul>
                
                <div class="add-form">
                    <h4>Agregar Menú</h4>
                    <form id="add-menu-form">
                        <div class="form-group">
                            <label for="menu-name">Nombre</label>
                            <input type="text" id="menu-name" required>
                        </div>
                        <div class="form-group">
                            <label for="menu-date">Fecha</label>
                            <input type="date" id="menu-date" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </form>
                </div>
            </div>
            
            <div class="panel-section">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> Coordinadores</h3>
                    <button class="refresh-btn" id="refresh-coordinators">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <ul id="coordinator-list" class="item-list">
                    <!-- Se llenará dinámicamente -->
                </ul>
                
                <div class="add-form">
                    <h4>Agregar Coordinador</h4>
                    <form id="add-coordinator-form">
                        <div class="form-group">
                            <label for="coordinator-name">Nombre</label>
                            <input type="text" id="coordinator-name" required>
                        </div>
                        <div class="form-group">
                            <label for="coordinator-department">Departamento</label>
                            <input type="text" id="coordinator-department" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Agregar</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="update-log">
            <h3>Registro de Actualizaciones en Tiempo Real</h3>
            <div id="log-container">
                <!-- Se llenará dinámicamente -->
            </div>
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Comedor Empresarial. Todos los derechos reservados.</p>
        </div>
    </footer>
    
    <script type="module">
        // Importar las funciones necesarias
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import FirebaseAuth from './js/firebase-auth.js';
        import RealtimeSync from './js/firebase-realtime.js';
        import MenuModel from './js/firebase-menu-model.js';
        import CoordinatorModel from './js/firebase-coordinator-model.js';
        import { logError, logCustomEvent } from './js/firebase-monitoring.js';
        
        // Elementos del DOM
        const userContainer = document.getElementById('user-container');
        const userEmail = document.getElementById('user-email');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const firebaseStatus = document.getElementById('firebase-status');
        const menuList = document.getElementById('menu-list');
        const coordinatorList = document.getElementById('coordinator-list');
        const refreshMenusBtn = document.getElementById('refresh-menus');
        const refreshCoordinatorsBtn = document.getElementById('refresh-coordinators');
        const addMenuForm = document.getElementById('add-menu-form');
        const addCoordinatorForm = document.getElementById('add-coordinator-form');
        const logContainer = document.getElementById('log-container');
        
        // Listeners activos
        let listeners = {};
        
        // Inicializar Firebase Auth
        FirebaseAuth.init().then(user => {
            updateAuthUI(user);
            
            if (user) {
                // Configurar sincronización en tiempo real
                setupRealtimeSync();
            }
        });
        
        // Actualizar la interfaz según el estado de autenticación
        function updateAuthUI(user) {
            if (user) {
                userEmail.textContent = user.email;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                // Actualizar estado de conexión
                firebaseStatus.className = 'status-badge status-online';
                firebaseStatus.innerHTML = '<i class="fas fa-cloud"></i> Online';
            } else {
                userEmail.textContent = '';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                
                // Actualizar estado de conexión
                firebaseStatus.className = 'status-badge status-offline';
                firebaseStatus.innerHTML = '<i class="fas fa-cloud"></i> Offline';
            }
        }
        
        // Cerrar sesión
        logoutBtn.addEventListener('click', async () => {
            try {
                // Cancelar todos los listeners
                for (const key in listeners) {
                    RealtimeSync.cancelListener(listeners[key]);
                }
                
                await FirebaseAuth.logout();
                updateAuthUI(null);
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión');
            }
        });
        
        // Verificar estado de autenticación
        onAuthStateChanged(auth, (user) => {
            updateAuthUI(user);
        });
        
        // Configurar sincronización en tiempo real
        function setupRealtimeSync() {
            // Escuchar cambios en menús
            listeners.menus = RealtimeSync.listenToCollection('menus', (menus) => {
                updateMenuList(menus);
                addLogEntry('Menús actualizados', menus.length);
            });
            
            // Escuchar cambios en coordinadores
            listeners.coordinators = RealtimeSync.listenToCollection('coordinators', (coordinators) => {
                updateCoordinatorList(coordinators);
                addLogEntry('Coordinadores actualizados', coordinators.length);
            });
        }
        
        // Actualizar lista de menús
        function updateMenuList(menus) {
            if (!menus || menus.length === 0) {
                menuList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-times"></i>
                        <p>No hay menús disponibles</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar menús por fecha (más recientes primero)
            menus.sort((a, b) => {
                return new Date(b.date) - new Date(a.date);
            });
            
            // Construir HTML
            let html = '';
            
            menus.forEach(menu => {
                const date = new Date(menu.date).toLocaleDateString();
                const isActive = menu.active ? '<span class="status-badge status-online">Activo</span>' : '';
                
                html += `
                    <li class="list-item" data-id="${menu.id}">
                        <div>
                            <div class="item-name">${menu.name || 'Menú sin nombre'} ${isActive}</div>
                            <div class="item-meta">Fecha: ${date}</div>
                        </div>
                        <div class="item-actions">
                            <button class="edit-btn activate-menu" data-id="${menu.id}" title="Activar">
                                <i class="fas fa-check-circle"></i>
                            </button>
                            <button class="delete-btn delete-menu" data-id="${menu.id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            menuList.innerHTML = html;
            
            // Agregar event listeners
            document.querySelectorAll('.activate-menu').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const menuId = e.currentTarget.dataset.id;
                    try {
                        await MenuModel.activate(menuId);
                        addLogEntry('Menú activado', menuId);
                    } catch (error) {
                        console.error('Error al activar menú:', error);
                        alert('Error al activar menú');
                    }
                });
            });
            
            document.querySelectorAll('.delete-menu').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const menuId = e.currentTarget.dataset.id;
                    if (confirm('¿Está seguro de que desea eliminar este menú?')) {
                        try {
                            await MenuModel.delete(menuId);
                            addLogEntry('Menú eliminado', menuId);
                        } catch (error) {
                            console.error('Error al eliminar menú:', error);
                            alert('Error al eliminar menú');
                        }
                    }
                });
            });
        }
        
        // Actualizar lista de coordinadores
        function updateCoordinatorList(coordinators) {
            if (!coordinators || coordinators.length === 0) {
                coordinatorList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <p>No hay coordinadores disponibles</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar coordinadores por nombre
            coordinators.sort((a, b) => {
                return (a.name || '').localeCompare(b.name || '');
            });
            
            // Construir HTML
            let html = '';
            
            coordinators.forEach(coordinator => {
                const isActive = coordinator.active ? '<span class="status-badge status-online">Activo</span>' : '<span class="status-badge status-offline">Inactivo</span>';
                
                html += `
                    <li class="list-item" data-id="${coordinator.id}">
                        <div>
                            <div class="item-name">${coordinator.name || 'Sin nombre'} ${isActive}</div>
                            <div class="item-meta">Departamento: ${coordinator.department || 'No especificado'}</div>
                        </div>
                        <div class="item-actions">
                            <button class="edit-btn toggle-coordinator" data-id="${coordinator.id}" data-active="${coordinator.active}" title="${coordinator.active ? 'Desactivar' : 'Activar'}">
                                <i class="fas ${coordinator.active ? 'fa-user-slash' : 'fa-user-check'}"></i>
                            </button>
                            <button class="delete-btn delete-coordinator" data-id="${coordinator.id}" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            coordinatorList.innerHTML = html;
            
            // Agregar event listeners
            document.querySelectorAll('.toggle-coordinator').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const coordinatorId = e.currentTarget.dataset.id;
                    const isActive = e.currentTarget.dataset.active === 'true';
                    
                    try {
                        await CoordinatorModel.update(coordinatorId, { active: !isActive });
                        addLogEntry(`Coordinador ${isActive ? 'desactivado' : 'activado'}`, coordinatorId);
                    } catch (error) {
                        console.error('Error al cambiar estado del coordinador:', error);
                        alert('Error al cambiar estado del coordinador');
                    }
                });
            });
            
            document.querySelectorAll('.delete-coordinator').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const coordinatorId = e.currentTarget.dataset.id;
                    if (confirm('¿Está seguro de que desea eliminar este coordinador?')) {
                        try {
                            await CoordinatorModel.delete(coordinatorId);
                            addLogEntry('Coordinador eliminado', coordinatorId);
                        } catch (error) {
                            console.error('Error al eliminar coordinador:', error);
                            alert('Error al eliminar coordinador');
                        }
                    }
                });
            });
        }
        
        // Agregar entrada al registro de actualizaciones
        function addLogEntry(message, detail) {
            const now = new Date();
            const timestamp = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
            
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry');
            logEntry.innerHTML = `<span class="log-timestamp">[${timestamp}]</span> ${message}: ${detail}`;
            
            logContainer.prepend(logEntry);
            
            // Limitar a 50 entradas
            const entries = logContainer.querySelectorAll('.log-entry');
            if (entries.length > 50) {
                for (let i = 50; i < entries.length; i++) {
                    entries[i].remove();
                }
            }
        }
        
        // Event listeners para formularios
        addMenuForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('menu-name').value;
            const date = document.getElementById('menu-date').value;
            
            try {
                // Crear menú
                const menuId = await MenuModel.create({
                    name: name,
                    date: date,
                    items: [],
                    active: false
                });
                
                addLogEntry('Menú creado', menuId);
                addMenuForm.reset();
            } catch (error) {
                console.error('Error al crear menú:', error);
                alert('Error al crear menú');
            }
        });
        
        addCoordinatorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('coordinator-name').value;
            const department = document.getElementById('coordinator-department').value;
            
            try {
                // Generar código de acceso
                const accessCode = await CoordinatorModel.generateAccessCode();
                
                // Crear coordinador
                const coordinatorId = await CoordinatorModel.create({
                    name: name,
                    department: department,
                    accessCode: accessCode,
                    active: true
                });
                
                addLogEntry('Coordinador creado', coordinatorId);
                alert(`Coordinador creado con código de acceso: ${accessCode}`);
                addCoordinatorForm.reset();
            } catch (error) {
                console.error('Error al crear coordinador:', error);
                alert('Error al crear coordinador');
            }
        });
        
        // Event listeners para botones de actualización manual
        refreshMenusBtn.addEventListener('click', async () => {
            try {
                const menus = await MenuModel.getAll();
                updateMenuList(menus);
                addLogEntry('Menús actualizados manualmente', menus.length);
            } catch (error) {
                console.error('Error al actualizar menús:', error);
                alert('Error al actualizar menús');
            }
        });
        
        refreshCoordinatorsBtn.addEventListener('click', async () => {
            try {
                const coordinators = await CoordinatorModel.getAll();
                updateCoordinatorList(coordinators);
                addLogEntry('Coordinadores actualizados manualmente', coordinators.length);
            } catch (error) {
                console.error('Error al actualizar coordinadores:', error);
                alert('Error al actualizar coordinadores');
            }
        });
    </script>
</body>
</html>
