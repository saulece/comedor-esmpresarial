<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportación e Importación de Datos - Comedor Empresarial</title>
    <meta name="description" content="Demostración de exportación e importación de datos para el Sistema de Confirmación de Asistencias">
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css" media="(max-width: 768px)">
    <!-- SheetJS (XLSX) para exportación a Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="app">
        <!-- Contenedor principal de la aplicación -->
        <header class="header">
            <div class="container">
                <h1>Exportación e Importación de Datos</h1>
                <div class="user-info">
                    <span class="username">Demostración</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <section class="section">
                    <h2>Sistema de Exportación e Importación</h2>
                    <p>Esta página demuestra las funcionalidades de exportación e importación de datos para el Sistema de Confirmación de Asistencias para Comedor Empresarial.</p>
                    
                    <div class="tabs" id="demo-tabs">
                        <button class="tab-btn active" data-tab="export-tab">Exportación</button>
                        <button class="tab-btn" data-tab="import-tab">Importación</button>
                        <button class="tab-btn" data-tab="examples-tab">Ejemplos</button>
                    </div>
                    
                    <!-- Tab de Exportación -->
                    <div id="export-tab" class="tab-content active">
                        <h3>Exportación de Datos</h3>
                        <p>Seleccione el tipo de datos que desea exportar y el formato de salida.</p>
                        
                        <div class="form-group">
                            <label for="export-data-type">Tipo de Datos:</label>
                            <select id="export-data-type" class="form-control">
                                <option value="menus">Menús Semanales</option>
                                <option value="confirmations">Confirmaciones de Asistencia</option>
                                <option value="coordinators">Coordinadores</option>
                                <option value="report">Reporte de Asistencia</option>
                            </select>
                        </div>
                        
                        <div id="report-options" class="form-group" style="display: none;">
                            <label for="report-menu-id">Seleccionar Menú para Reporte:</label>
                            <select id="report-menu-id" class="form-control">
                                <!-- Se llenará dinámicamente -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Formato de Exportación:</label>
                            <div class="btn-group">
                                <button id="export-excel" class="btn btn-primary">Excel (.xlsx)</button>
                                <button id="export-csv" class="btn btn-secondary">CSV (.csv)</button>
                                <button id="export-json" class="btn btn-secondary">JSON (.json)</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="export-filename">Nombre del Archivo (sin extensión):</label>
                            <input type="text" id="export-filename" class="form-control" value="exportacion-comedor">
                        </div>
                    </div>
                    
                    <!-- Tab de Importación -->
                    <div id="import-tab" class="tab-content">
                        <h3>Importación de Datos</h3>
                        <p>Seleccione el tipo de datos que desea importar y el archivo correspondiente.</p>
                        
                        <div class="form-group">
                            <label for="import-data-type">Tipo de Datos:</label>
                            <select id="import-data-type" class="form-control">
                                <option value="menus">Menús Semanales</option>
                                <option value="confirmations">Confirmaciones de Asistencia</option>
                                <option value="coordinators">Coordinadores</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="import-file">Archivo a Importar:</label>
                            <input type="file" id="import-file" class="form-control" accept=".xlsx,.csv,.json">
                        </div>
                        
                        <div class="form-group">
                            <button id="import-button" class="btn btn-primary">Importar Datos</button>
                        </div>
                        
                        <div class="form-group">
                            <div class="alert alert-warning">
                                <strong>Nota:</strong> La importación reemplazará los datos existentes del tipo seleccionado. Asegúrese de tener una copia de seguridad antes de proceder.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab de Ejemplos -->
                    <div id="examples-tab" class="tab-content">
                        <h3>Ejemplos de Uso</h3>
                        <p>A continuación se muestran ejemplos de cómo utilizar las funciones de exportación e importación en su código.</p>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4>Exportar Menús a Excel</h4>
                            </div>
                            <div class="card-body">
                                <pre><code>// Preparar datos de menús para exportación
const menuData = ExportImport.prepareMenusForExport();

// Exportar a Excel
ExportImport.exportToExcel(
    menuData.rows,
    menuData.headers,
    'Menús Semanales',
    'menus-comedor'
);</code></pre>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4>Exportar Reporte de Asistencia a CSV</h4>
                            </div>
                            <div class="card-body">
                                <pre><code>// Preparar datos de reporte para exportación
const reportData = ExportImport.prepareReportForExport('menu-id-123');

// Exportar a CSV
ExportImport.exportToCSV(
    reportData.rows,
    reportData.headers,
    'reporte-asistencia'
);</code></pre>
                            </div>
                        </div>
                        
                        <div class="card mb-3">
                            <div class="card-header">
                                <h4>Importar Datos desde Excel</h4>
                            </div>
                            <div class="card-body">
                                <pre><code>// Obtener archivo del input
const fileInput = document.getElementById('import-file');
const file = fileInput.files[0];

// Importar datos
ExportImport.importFromExcel(file)
    .then(data => {
        console.log('Datos importados:', data);
        // Procesar datos importados
    })
    .catch(error => {
        console.error('Error al importar:', error);
    });</code></pre>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Previsualización de datos -->
                    <div id="data-preview" class="mt-4" style="display: none;">
                        <h3>Previsualización de Datos</h3>
                        <div class="table-responsive">
                            <table id="preview-table" class="table table-striped">
                                <!-- Se llenará dinámicamente -->
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer class="footer">
            <div class="container">
                <p>&copy; 2025 Sistema de Confirmación de Asistencias - Comedor Empresarial</p>
            </div>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/models.js"></script>
    <script src="js/components.js"></script>
    <script src="js/export-import.js"></script>
    
    <!-- Script para la demostración -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tabs
            initTabs();
            
            // Inicializar eventos de exportación
            initExportEvents();
            
            // Inicializar eventos de importación
            initImportEvents();
            
            // Cargar datos de ejemplo
            loadSampleData();
        });
        
        function initTabs() {
            const tabBtns = document.querySelectorAll('#demo-tabs .tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Desactivar todas las pestañas
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Activar la pestaña seleccionada
                    btn.classList.add('active');
                    const tabId = btn.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function initExportEvents() {
            // Mostrar/ocultar opciones de reporte
            document.getElementById('export-data-type').addEventListener('change', function() {
                const reportOptions = document.getElementById('report-options');
                reportOptions.style.display = this.value === 'report' ? 'block' : 'none';
                
                updateDataPreview();
            });
            
            // Botones de exportación
            document.getElementById('export-excel').addEventListener('click', function() {
                exportData('excel');
            });
            
            document.getElementById('export-csv').addEventListener('click', function() {
                exportData('csv');
            });
            
            document.getElementById('export-json').addEventListener('click', function() {
                exportData('json');
            });
            
            // Actualizar previsualización al cambiar menú para reporte
            document.getElementById('report-menu-id').addEventListener('change', function() {
                updateDataPreview();
            });
        }
        
        function initImportEvents() {
            // Botón de importación
            document.getElementById('import-button').addEventListener('click', function() {
                importData();
            });
            
            // Mostrar previsualización al seleccionar archivo
            document.getElementById('import-file').addEventListener('change', function() {
                const file = this.files[0];
                if (!file) return;
                
                // Determinar formato según extensión
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (extension === 'xlsx') {
                    ExportImport.importFromExcel(file)
                        .then(data => {
                            showImportPreview(data);
                        })
                        .catch(error => {
                            console.error('Error al importar Excel:', error);
                        });
                } else if (extension === 'csv') {
                    ExportImport.importFromCSV(file)
                        .then(data => {
                            showImportPreview(data);
                        })
                        .catch(error => {
                            console.error('Error al importar CSV:', error);
                        });
                } else if (extension === 'json') {
                    ExportImport.importFromJSON(file)
                        .then(data => {
                            // Formato especial para JSON
                            const headers = Object.keys(data[0] || {});
                            const rows = data.map(item => headers.map(key => item[key]));
                            showImportPreview({ headers, rows });
                        })
                        .catch(error => {
                            console.error('Error al importar JSON:', error);
                        });
                }
            });
        }
        
        function exportData(format) {
            const dataType = document.getElementById('export-data-type').value;
            const fileName = document.getElementById('export-filename').value || 'exportacion-comedor';
            
            let exportData;
            
            // Obtener datos según el tipo seleccionado
            switch (dataType) {
                case 'menus':
                    exportData = ExportImport.prepareMenusForExport();
                    break;
                case 'confirmations':
                    exportData = ExportImport.prepareConfirmationsForExport();
                    break;
                case 'coordinators':
                    exportData = ExportImport.prepareCoordinatorsForExport();
                    break;
                case 'report':
                    const menuId = document.getElementById('report-menu-id').value;
                    exportData = ExportImport.prepareReportForExport(menuId);
                    break;
                default:
                    Components.showToast('Tipo de datos no válido', 'danger');
                    return;
            }
            
            // Exportar según el formato seleccionado
            switch (format) {
                case 'excel':
                    ExportImport.exportToExcel(exportData.rows, exportData.headers, dataType, fileName);
                    break;
                case 'csv':
                    ExportImport.exportToCSV(exportData.rows, exportData.headers, fileName);
                    break;
                case 'json':
                    // Convertir a formato JSON adecuado
                    const jsonData = exportData.rows.map(row => {
                        const obj = {};
                        exportData.headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });
                    ExportImport.exportToJSON(jsonData, fileName);
                    break;
                default:
                    Components.showToast('Formato no válido', 'danger');
            }
        }
        
        function importData() {
            const dataType = document.getElementById('import-data-type').value;
            const fileInput = document.getElementById('import-file');
            const file = fileInput.files[0];
            
            if (!file) {
                Components.showToast('Por favor, seleccione un archivo', 'warning');
                return;
            }
            
            // Determinar formato según extensión
            const extension = file.name.split('.').pop().toLowerCase();
            let importFunction;
            
            switch (extension) {
                case 'xlsx':
                    importFunction = ExportImport.importFromExcel;
                    break;
                case 'csv':
                    importFunction = ExportImport.importFromCSV;
                    break;
                case 'json':
                    importFunction = ExportImport.importFromJSON;
                    break;
                default:
                    Components.showToast('Formato de archivo no soportado', 'danger');
                    return;
            }
            
            // Mostrar diálogo de confirmación
            Components.showConfirmDialog({
                title: 'Confirmar Importación',
                message: `¿Está seguro de que desea importar los datos de ${dataType}? Esta acción reemplazará los datos existentes.`,
                onConfirm: function() {
                    // Proceder con la importación
                    importFunction(file)
                        .then(data => {
                            // Aquí se procesarían los datos importados
                            // En una implementación real, se guardarían en el modelo correspondiente
                            Components.showToast(`Datos de ${dataType} importados correctamente`, 'success');
                        })
                        .catch(error => {
                            console.error('Error al importar:', error);
                            Components.showToast('Error al importar datos', 'danger');
                        });
                }
            });
        }
        
        function updateDataPreview() {
            const dataType = document.getElementById('export-data-type').value;
            let exportData;
            
            // Obtener datos según el tipo seleccionado
            switch (dataType) {
                case 'menus':
                    exportData = ExportImport.prepareMenusForExport();
                    break;
                case 'confirmations':
                    exportData = ExportImport.prepareConfirmationsForExport();
                    break;
                case 'coordinators':
                    exportData = ExportImport.prepareCoordinatorsForExport();
                    break;
                case 'report':
                    const menuId = document.getElementById('report-menu-id').value;
                    exportData = ExportImport.prepareReportForExport(menuId);
                    break;
                default:
                    return;
            }
            
            // Mostrar previsualización
            showDataPreview(exportData);
        }
        
        function showDataPreview(data) {
            const previewContainer = document.getElementById('data-preview');
            const previewTable = document.getElementById('preview-table');
            
            // Limpiar tabla
            previewTable.innerHTML = '';
            
            // Crear encabezados
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);
            
            // Crear filas de datos (máximo 5 para previsualización)
            const tbody = document.createElement('tbody');
            const maxRows = Math.min(data.rows.length, 5);
            
            for (let i = 0; i < maxRows; i++) {
                const row = document.createElement('tr');
                
                data.rows[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            previewTable.appendChild(tbody);
            
            // Mostrar contenedor de previsualización
            previewContainer.style.display = 'block';
        }
        
        function showImportPreview(data) {
            const previewContainer = document.getElementById('data-preview');
            const previewTable = document.getElementById('preview-table');
            
            // Limpiar tabla
            previewTable.innerHTML = '';
            
            // Crear encabezados
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            data.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);
            
            // Crear filas de datos (máximo 5 para previsualización)
            const tbody = document.createElement('tbody');
            const maxRows = Math.min(data.rows.length, 5);
            
            for (let i = 0; i < maxRows; i++) {
                const row = document.createElement('tr');
                
                data.rows[i].forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    row.appendChild(td);
                });
                
                tbody.appendChild(row);
            }
            
            previewTable.appendChild(tbody);
            
            // Mostrar contenedor de previsualización
            previewContainer.style.display = 'block';
        }
        
        function loadSampleData() {
            // Datos de ejemplo para la demostración
            const sampleMenus = [
                {
                    id: 'menu-1',
                    weekStart: '2025-04-21',
                    status: 'published',
                    days: [
                        { dayOfWeek: 1, mainDish: 'Pollo al horno', sideDish: 'Puré de papas', drink: 'Jugo de naranja' },
                        { dayOfWeek: 2, mainDish: 'Pescado a la plancha', sideDish: 'Ensalada mixta', drink: 'Agua mineral' },
                        { dayOfWeek: 3, mainDish: 'Pasta con salsa boloñesa', sideDish: 'Pan de ajo', drink: 'Refresco' },
                        { dayOfWeek: 4, mainDish: 'Carne asada', sideDish: 'Arroz blanco', drink: 'Limonada' },
                        { dayOfWeek: 5, mainDish: 'Tacos de pollo', sideDish: 'Frijoles refritos', drink: 'Agua de jamaica' }
                    ]
                },
                {
                    id: 'menu-2',
                    weekStart: '2025-04-28',
                    status: 'draft',
                    days: [
                        { dayOfWeek: 1, mainDish: 'Lomo saltado', sideDish: 'Arroz blanco', drink: 'Chicha morada' },
                        { dayOfWeek: 2, mainDish: 'Pollo a la parrilla', sideDish: 'Papas fritas', drink: 'Refresco' },
                        { dayOfWeek: 3, mainDish: 'Lasaña de carne', sideDish: 'Ensalada César', drink: 'Agua mineral' },
                        { dayOfWeek: 4, mainDish: 'Chuletas de cerdo', sideDish: 'Puré de camote', drink: 'Jugo de piña' },
                        { dayOfWeek: 5, mainDish: 'Arroz con pollo', sideDish: 'Ensalada de aguacate', drink: 'Limonada' }
                    ]
                }
            ];
            
            const sampleCoordinators = [
                { id: 'coord-1', name: 'Juan Pérez', username: 'jperez', maxPeople: 20 },
                { id: 'coord-2', name: 'María López', username: 'mlopez', maxPeople: 15 },
                { id: 'coord-3', name: 'Carlos Gómez', username: 'cgomez', maxPeople: 10 }
            ];
            
            const sampleConfirmations = [
                {
                    id: 'conf-1',
                    coordinatorId: 'coord-1',
                    weekStart: '2025-04-21',
                    days: [
                        { dayOfWeek: 1, attendees: 15 },
                        { dayOfWeek: 2, attendees: 18 },
                        { dayOfWeek: 3, attendees: 20 },
                        { dayOfWeek: 4, attendees: 17 },
                        { dayOfWeek: 5, attendees: 12 }
                    ]
                },
                {
                    id: 'conf-2',
                    coordinatorId: 'coord-2',
                    weekStart: '2025-04-21',
                    days: [
                        { dayOfWeek: 1, attendees: 10 },
                        { dayOfWeek: 2, attendees: 12 },
                        { dayOfWeek: 3, attendees: 15 },
                        { dayOfWeek: 4, attendees: 14 },
                        { dayOfWeek: 5, attendees: 8 }
                    ]
                }
            ];
            
            // Guardar datos de ejemplo en localStorage
            localStorage.setItem(CONFIG.STORAGE_KEYS.MENUS, JSON.stringify(sampleMenus));
            localStorage.setItem(CONFIG.STORAGE_KEYS.USERS, JSON.stringify(sampleCoordinators));
            localStorage.setItem(CONFIG.STORAGE_KEYS.CONFIRMATIONS, JSON.stringify(sampleConfirmations));
            
            // Llenar selector de menús para reportes
            const menuSelect = document.getElementById('report-menu-id');
            menuSelect.innerHTML = '';
            
            sampleMenus.forEach(menu => {
                const option = document.createElement('option');
                option.value = menu.id;
                option.textContent = `Semana del ${Utils.formatDate(menu.weekStart)} (${menu.status})`;
                menuSelect.appendChild(option);
            });
            
            // Actualizar previsualización inicial
            updateDataPreview();
        }
    </script>
</body>
</html>
