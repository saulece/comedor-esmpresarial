<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Comedor Empresarial</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .user-management-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .user-list {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-list th, .user-list td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .user-list th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .user-list tr:hover {
            background-color: #f9f9f9;
        }
        
        .user-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .btn-edit {
            background-color: #4285F4;
            color: white;
        }
        
        .btn-delete {
            background-color: #EA4335;
            color: white;
        }
        
        .btn-activate {
            background-color: #34A853;
            color: white;
        }
        
        .btn-deactivate {
            background-color: #FBBC05;
            color: white;
        }
        
        .user-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: bold;
        }
        
        .filter-group select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        .user-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .status-active {
            background-color: #E6F4EA;
            color: #137333;
        }
        
        .status-inactive {
            background-color: #FCE8E6;
            color: #C5221F;
        }
        
        .user-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        @media (max-width: 768px) {
            .user-list {
                font-size: 0.9rem;
            }
            
            .user-list th, .user-list td {
                padding: 8px;
            }
            
            .user-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .user-filters {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Comedor Empresarial</h1>
            <nav>
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="admin.html">Administración</a></li>
                    <li><a href="coordinator.html">Coordinador</a></li>
                    <li><a href="user-management.html" class="active">Usuarios</a></li>
                    <li><a href="firebase-config.html">Configuración</a></li>
                </ul>
                <div id="user-container" class="user-info">
                    <span id="user-email"></span>
                    <a id="login-btn" href="login.html" class="btn btn-small">Iniciar Sesión</a>
                    <button id="logout-btn" class="btn btn-small" style="display: none;">Cerrar Sesión</button>
                </div>
            </nav>
        </div>
    </header>
    
    <main class="user-management-container">
        <h2>Gestión de Usuarios</h2>
        
        <div class="action-bar">
            <button id="add-user-btn" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Agregar Usuario
            </button>
        </div>
        
        <div class="user-filters">
            <div class="filter-group">
                <label for="role-filter">Rol:</label>
                <select id="role-filter">
                    <option value="">Todos</option>
                    <option value="admin">Administrador</option>
                    <option value="coordinator">Coordinador</option>
                    <option value="employee">Empleado</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="department-filter">Departamento:</label>
                <select id="department-filter">
                    <option value="">Todos</option>
                    <!-- Se llenará dinámicamente -->
                </select>
            </div>
            
            <div class="filter-group">
                <label for="status-filter">Estado:</label>
                <select id="status-filter">
                    <option value="">Todos</option>
                    <option value="active">Activo</option>
                    <option value="inactive">Inactivo</option>
                </select>
            </div>
        </div>
        
        <div id="user-list-container">
            <table class="user-list">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Rol</th>
                        <th>Departamento</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="user-list-body">
                    <!-- Se llenará dinámicamente -->
                </tbody>
            </table>
            
            <div id="empty-state" class="empty-state" style="display: none;">
                <i class="fas fa-users"></i>
                <p>No hay usuarios que coincidan con los filtros seleccionados.</p>
            </div>
        </div>
    </main>
    
    <!-- Modal para agregar/editar usuario -->
    <div id="user-modal" class="user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Agregar Usuario</h3>
                <button class="modal-close">&times;</button>
            </div>
            
            <form id="user-form">
                <input type="hidden" id="user-id">
                
                <div class="form-group">
                    <label for="user-name">Nombre Completo</label>
                    <input type="text" id="user-name" required>
                </div>
                
                <div class="form-group">
                    <label for="user-email">Email</label>
                    <input type="email" id="user-email-input" required>
                </div>
                
                <div class="form-group" id="password-group">
                    <label for="user-password">Contraseña</label>
                    <input type="password" id="user-password" required>
                </div>
                
                <div class="form-group">
                    <label for="user-role">Rol</label>
                    <select id="user-role" required>
                        <option value="admin">Administrador</option>
                        <option value="coordinator">Coordinador</option>
                        <option value="employee">Empleado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="user-department">Departamento</label>
                    <input type="text" id="user-department">
                </div>
                
                <div class="form-group" id="status-group">
                    <label for="user-active">Estado</label>
                    <select id="user-active">
                        <option value="true">Activo</option>
                        <option value="false">Inactivo</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary modal-close-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>&copy; 2025 Comedor Empresarial. Todos los derechos reservados.</p>
        </div>
    </footer>
    
    <script type="module">
        // Importar las funciones necesarias
        import { auth, onAuthStateChanged } from './js/firebase-config.js';
        import FirebaseAuth from './js/firebase-auth.js';
        import UserManagement from './js/firebase-user-management.js';
        import { logError, logCustomEvent } from './js/firebase-monitoring.js';
        
        // Elementos del DOM
        const userContainer = document.getElementById('user-container');
        const userEmail = document.getElementById('user-email');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userListBody = document.getElementById('user-list-body');
        const emptyState = document.getElementById('empty-state');
        const addUserBtn = document.getElementById('add-user-btn');
        const userModal = document.getElementById('user-modal');
        const modalTitle = document.getElementById('modal-title');
        const userForm = document.getElementById('user-form');
        const userId = document.getElementById('user-id');
        const userName = document.getElementById('user-name');
        const userEmailInput = document.getElementById('user-email-input');
        const userPassword = document.getElementById('user-password');
        const userRole = document.getElementById('user-role');
        const userDepartment = document.getElementById('user-department');
        const userActive = document.getElementById('user-active');
        const passwordGroup = document.getElementById('password-group');
        const statusGroup = document.getElementById('status-group');
        const roleFilter = document.getElementById('role-filter');
        const departmentFilter = document.getElementById('department-filter');
        const statusFilter = document.getElementById('status-filter');
        const modalCloseBtn = document.querySelector('.modal-close-btn');
        const modalClose = document.querySelector('.modal-close');
        
        // Variables globales
        let allUsers = [];
        let departments = new Set();
        
        // Inicializar Firebase Auth
        FirebaseAuth.init().then(user => {
            updateAuthUI(user);
            
            if (user) {
                // Verificar si el usuario es administrador
                UserManagement.hasRole(UserManagement.ROLES.ADMIN).then(isAdmin => {
                    if (isAdmin) {
                        // Cargar usuarios
                        loadUsers();
                    } else {
                        // Redirigir a la página principal si no es administrador
                        window.location.href = 'index.html';
                        alert('No tiene permisos para acceder a esta página');
                    }
                });
            } else {
                // Redirigir a la página de inicio de sesión
                window.location.href = 'login.html?redirect=user-management.html';
            }
        });
        
        // Actualizar la interfaz según el estado de autenticación
        function updateAuthUI(user) {
            if (user) {
                userEmail.textContent = user.email;
                loginBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
            } else {
                userEmail.textContent = '';
                loginBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
            }
        }
        
        // Cerrar sesión
        logoutBtn.addEventListener('click', async () => {
            try {
                await FirebaseAuth.logout();
                updateAuthUI(null);
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión');
            }
        });
        
        // Verificar estado de autenticación
        onAuthStateChanged(auth, (user) => {
            updateAuthUI(user);
        });
        
        // Cargar usuarios
        async function loadUsers() {
            try {
                // Obtener todos los usuarios
                allUsers = await UserManagement.getAllUsers();
                
                // Extraer departamentos únicos
                departments = new Set();
                allUsers.forEach(user => {
                    if (user.department) {
                        departments.add(user.department);
                    }
                });
                
                // Llenar selector de departamentos
                fillDepartmentFilter();
                
                // Aplicar filtros iniciales
                applyFilters();
                
                // Registrar evento
                logCustomEvent('users_loaded', { count: allUsers.length });
            } catch (error) {
                logError(error, { operation: 'loadUsers' });
                console.error('Error al cargar usuarios:', error);
                alert('Error al cargar usuarios');
            }
        }
        
        // Llenar selector de departamentos
        function fillDepartmentFilter() {
            const departmentFilter = document.getElementById('department-filter');
            departmentFilter.innerHTML = '<option value="">Todos</option>';
            
            // Ordenar departamentos alfabéticamente
            const sortedDepartments = Array.from(departments).sort();
            
            sortedDepartments.forEach(department => {
                const option = document.createElement('option');
                option.value = department;
                option.textContent = department;
                departmentFilter.appendChild(option);
            });
        }
        
        // Aplicar filtros
        function applyFilters() {
            const roleValue = roleFilter.value;
            const departmentValue = departmentFilter.value;
            const statusValue = statusFilter.value;
            
            // Filtrar usuarios
            const filteredUsers = allUsers.filter(user => {
                // Filtro por rol
                if (roleValue && user.role !== roleValue) {
                    return false;
                }
                
                // Filtro por departamento
                if (departmentValue && user.department !== departmentValue) {
                    return false;
                }
                
                // Filtro por estado
                if (statusValue === 'active' && user.active !== true) {
                    return false;
                }
                
                if (statusValue === 'inactive' && user.active !== false) {
                    return false;
                }
                
                return true;
            });
            
            // Mostrar usuarios filtrados
            renderUsers(filteredUsers);
        }
        
        // Renderizar usuarios en la tabla
        function renderUsers(users) {
            userListBody.innerHTML = '';
            
            if (users.length === 0) {
                emptyState.style.display = 'block';
                document.querySelector('.user-list').style.display = 'none';
                return;
            }
            
            emptyState.style.display = 'none';
            document.querySelector('.user-list').style.display = 'table';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                // Nombre
                const nameCell = document.createElement('td');
                nameCell.textContent = user.name || 'Sin nombre';
                row.appendChild(nameCell);
                
                // Email
                const emailCell = document.createElement('td');
                emailCell.textContent = user.email;
                row.appendChild(emailCell);
                
                // Rol
                const roleCell = document.createElement('td');
                let roleName = 'Desconocido';
                switch (user.role) {
                    case UserManagement.ROLES.ADMIN:
                        roleName = 'Administrador';
                        break;
                    case UserManagement.ROLES.COORDINATOR:
                        roleName = 'Coordinador';
                        break;
                    case UserManagement.ROLES.EMPLOYEE:
                        roleName = 'Empleado';
                        break;
                }
                roleCell.textContent = roleName;
                row.appendChild(roleCell);
                
                // Departamento
                const departmentCell = document.createElement('td');
                departmentCell.textContent = user.department || 'Sin departamento';
                row.appendChild(departmentCell);
                
                // Estado
                const statusCell = document.createElement('td');
                const statusSpan = document.createElement('span');
                statusSpan.classList.add('user-status');
                
                if (user.active === true) {
                    statusSpan.classList.add('status-active');
                    statusSpan.textContent = 'Activo';
                } else {
                    statusSpan.classList.add('status-inactive');
                    statusSpan.textContent = 'Inactivo';
                }
                
                statusCell.appendChild(statusSpan);
                row.appendChild(statusCell);
                
                // Acciones
                const actionsCell = document.createElement('td');
                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('user-actions');
                
                // Botón Editar
                const editBtn = document.createElement('button');
                editBtn.classList.add('btn', 'btn-small', 'btn-edit');
                editBtn.innerHTML = '<i class="fas fa-edit"></i> Editar';
                editBtn.addEventListener('click', () => editUser(user));
                actionsDiv.appendChild(editBtn);
                
                // Botón Activar/Desactivar
                const toggleBtn = document.createElement('button');
                toggleBtn.classList.add('btn', 'btn-small');
                
                if (user.active === true) {
                    toggleBtn.classList.add('btn-deactivate');
                    toggleBtn.innerHTML = '<i class="fas fa-user-slash"></i> Desactivar';
                    toggleBtn.addEventListener('click', () => toggleUserActive(user.id, false));
                } else {
                    toggleBtn.classList.add('btn-activate');
                    toggleBtn.innerHTML = '<i class="fas fa-user-check"></i> Activar';
                    toggleBtn.addEventListener('click', () => toggleUserActive(user.id, true));
                }
                
                actionsDiv.appendChild(toggleBtn);
                
                actionsCell.appendChild(actionsDiv);
                row.appendChild(actionsCell);
                
                userListBody.appendChild(row);
            });
        }
        
        // Editar usuario
        function editUser(user) {
            // Llenar formulario
            userId.value = user.id;
            userName.value = user.name || '';
            userEmailInput.value = user.email || '';
            userRole.value = user.role || UserManagement.ROLES.EMPLOYEE;
            userDepartment.value = user.department || '';
            userActive.value = user.active === false ? 'false' : 'true';
            
            // Cambiar título del modal
            modalTitle.textContent = 'Editar Usuario';
            
            // Ocultar campo de contraseña en edición
            passwordGroup.style.display = 'none';
            userPassword.required = false;
            
            // Mostrar campo de estado
            statusGroup.style.display = 'block';
            
            // Abrir modal
            userModal.style.display = 'flex';
        }
        
        // Activar/Desactivar usuario
        async function toggleUserActive(userId, active) {
            try {
                await UserManagement.setUserActive(userId, active);
                
                // Actualizar lista
                await loadUsers();
                
                // Mostrar mensaje
                alert(`Usuario ${active ? 'activado' : 'desactivado'} correctamente`);
                
                // Registrar evento
                logCustomEvent('user_status_changed', { userId, active });
            } catch (error) {
                logError(error, { operation: 'toggleUserActive', userId, active });
                console.error('Error al cambiar estado del usuario:', error);
                alert(`Error al ${active ? 'activar' : 'desactivar'} usuario: ${error.message}`);
            }
        }
        
        // Abrir modal para agregar usuario
        addUserBtn.addEventListener('click', () => {
            // Limpiar formulario
            userForm.reset();
            userId.value = '';
            
            // Cambiar título del modal
            modalTitle.textContent = 'Agregar Usuario';
            
            // Mostrar campo de contraseña
            passwordGroup.style.display = 'block';
            userPassword.required = true;
            
            // Ocultar campo de estado
            statusGroup.style.display = 'none';
            
            // Abrir modal
            userModal.style.display = 'flex';
        });
        
        // Cerrar modal
        modalClose.addEventListener('click', () => {
            userModal.style.display = 'none';
        });
        
        modalCloseBtn.addEventListener('click', () => {
            userModal.style.display = 'none';
        });
        
        // Cerrar modal al hacer clic fuera del contenido
        userModal.addEventListener('click', (e) => {
            if (e.target === userModal) {
                userModal.style.display = 'none';
            }
        });
        
        // Guardar usuario
        userForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const id = userId.value;
                const name = userName.value;
                const email = userEmailInput.value;
                const password = userPassword.value;
                const role = userRole.value;
                const department = userDepartment.value;
                const active = userActive.value === 'true';
                
                if (id) {
                    // Actualizar usuario existente
                    await UserManagement.updateUserProfile(id, {
                        name,
                        role,
                        department,
                        active
                    });
                    
                    // Registrar evento
                    logCustomEvent('user_updated', { userId: id });
                    
                    alert('Usuario actualizado correctamente');
                } else {
                    // Crear nuevo usuario
                    await UserManagement.registerUser(email, password, name, role, department);
                    
                    // Registrar evento
                    logCustomEvent('user_created', { email });
                    
                    alert('Usuario creado correctamente');
                }
                
                // Cerrar modal
                userModal.style.display = 'none';
                
                // Actualizar lista
                await loadUsers();
            } catch (error) {
                logError(error, { operation: 'saveUser' });
                console.error('Error al guardar usuario:', error);
                alert(`Error al guardar usuario: ${error.message}`);
            }
        });
        
        // Event listeners para filtros
        roleFilter.addEventListener('change', applyFilters);
        departmentFilter.addEventListener('change', applyFilters);
        statusFilter.addEventListener('change', applyFilters);
    </script>
</body>
</html>
